<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Trị - Chay Food</title>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        :root { --primary: #f97316; --bg: #f8fafc; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Be Vietnam Pro', sans-serif; }
        body { background: var(--bg); color: #334155; }
        
        /* LOGIN SCREEN */
        #login-screen { position: fixed; top:0; left:0; width:100%; height:100%; background: #fff7ed; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .login-box { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; width: 300px; }
        .login-box input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ddd; border-radius: 8px; outline: none; }
        .btn { padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        
        /* DASHBOARD */
        .header { background: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .logo { font-weight: 900; font-size: 20px; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        
        /* STATS CARDS */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); display: flex; align-items: center; gap: 15px; }
        .stat-icon { width: 50px; height: 50px; background: #fff7ed; color: var(--primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        
        /* TABLE */
        .table-container { background: white; border-radius: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 15px 20px; text-align: left; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        th { background: #f8fafc; font-weight: 600; color: #64748b; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-new { background: #dbeafe; color: #2563eb; }
        .action-btn { width: 32px; height: 32px; border-radius: 8px; border: none; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; margin-right: 5px; transition: 0.2s; }
        .btn-print { background: #e0f2fe; color: #0284c7; }
        .btn-del { background: #fee2e2; color: #ef4444; }
        .btn-print:hover { background: #0284c7; color: white; }
        .btn-del:hover { background: #ef4444; color: white; }

        /* LOADING */
        .loader { text-align: center; padding: 50px; color: #94a3b8; }
        .hidden { display: none !important; }

        /* PRINT STYLES */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; padding: 20px; background: white; color: black; }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color: var(--primary); margin-bottom: 10px;">Admin Chay Food</h2>
            <p style="color: #666; font-size: 13px;">Nhập mật khẩu để quản lý</p>
            <input type="password" id="admin-pass" placeholder="Mật khẩu (Gợi ý: admin123)">
            <button class="btn" onclick="checkLogin()">Đăng Nhập</button>
        </div>
    </div>

    <div id="admin-panel" class="hidden">
        <header class="header">
            <div class="logo"><i class="ri-leaf-fill"></i> QUẢN TRỊ VIÊN</div>
            <button class="btn" style="background: #334155;" onclick="location.reload()"><i class="ri-refresh-line"></i> Làm mới</button>
        </header>

        <div class="container">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon"><i class="ri-shopping-bag-3-fill"></i></div>
                    <div>
                        <div style="color: #64748b; font-size: 13px;">Tổng đơn hàng</div>
                        <div style="font-size: 24px; font-weight: 700;" id="total-orders">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="ri-money-dollar-circle-fill"></i></div>
                    <div>
                        <div style="color: #64748b; font-size: 13px;">Doanh thu ước tính</div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--primary);" id="total-revenue">0đ</div>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table id="data-table">
                    <thead>
                        <tr>
                            <th>Mã Đơn</th>
                            <th>Ngày đặt</th>
                            <th>Khách hàng</th>
                            <th>Món đặt</th>
                            <th>Tổng tiền</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        </tbody>
                </table>
                <div id="loading" class="loader"><i class="ri-loader-4-line" style="animation: spin 1s infinite linear; font-size: 30px;"></i><br>Đang tải dữ liệu...</div>
            </div>
        </div>
    </div>

    <div id="print-area" style="display: none;">
        <div style="text-align: center; border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 10px;">
            <h1 style="margin: 0; font-size: 24px;">CHAY FOOD</h1>
            <p style="margin: 5px 0;">ĐC: Xã Khoái Châu - Hưng Yên</p>
            <p>Hotline: 0967.428.022</p>
        </div>
        <h2 style="text-align: center;">HÓA ĐƠN BÁN LẺ</h2>
        <p><b>Mã đơn:</b> <span id="p-id"></span></p>
        <p><b>Khách hàng:</b> <span id="p-name"></span></p>
        <p><b>SĐT:</b> <span id="p-phone"></span></p>
        <p><b>Địa chỉ:</b> <span id="p-addr"></span></p>
        <hr style="border-top: 1px dashed #000;">
        <div id="p-items" style="margin: 10px 0;"></div>
        <hr style="border-top: 1px dashed #000;">
        <h3 style="text-align: right; margin-top: 10px;">TỔNG TIỀN: <span id="p-total"></span></h3>
        <p style="text-align: center; margin-top: 20px; font-style: italic;">Cảm ơn quý khách!</p>
    </div>

    <script>
        // --- CẤU HÌNH ---
        // QUAN TRỌNG: Dán link Script MỚI (đã update doGet) vào đây
        const API_URL = "https://script.google.com/macros/s/AKfycbyN92SiHPM7ocf99VG9D8486YSpI2Lk792wRU9tmd2VmUh_NeZwAF7jioZckCu-tIKG/execDÁN_LINK_APP_SCRIPT_CỦA_BẠN_VÀO_ĐÂY"; 

        // 1. ĐĂNG NHẬP
        function checkLogin() {
            const pass = document.getElementById('admin-pass').value;
            if(pass === 'admin123') { // Mật khẩu đơn giản
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                fetchOrders();
            } else {
                alert('Sai mật khẩu rồi!');
            }
        }

        // 2. LẤY DỮ LIỆU TỪ GOOGLE SHEET
        let allOrders = [];

        function fetchOrders() {
            fetch(API_URL)
            .then(res => res.json())
            .then(data => {
                allOrders = data;
                renderTable(data);
                calculateStats(data);
                document.getElementById('loading').classList.add('hidden');
            })
            .catch(err => {
                console.error(err);
                document.getElementById('loading').innerHTML = "Lỗi kết nối hoặc chưa cập nhật Script!";
            });
        }

        // 3. HIỂN THỊ BẢNG
        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            if(data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Chưa có đơn hàng nào</td></tr>';
                return;
            }

            data.forEach((order, index) => {
                // Format ngày tháng
                let dateStr = order.Time;
                try { dateStr = new Date(order.Time).toLocaleString('vi-VN'); } catch(e){}

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:bold; color:var(--primary)">${order.OrderId}</td>
                    <td style="color:#666; font-size:12px;">${dateStr}</td>
                    <td>
                        <div><b>${order.Name}</b></div>
                        <div style="font-size:12px; color:#666;">${order.Phone}</div>
                        <div style="font-size:12px; color:#666; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${order.Address}</div>
                    </td>
                    <td style="font-size:13px; max-width: 250px;">${order.Items}</td>
                    <td style="font-weight:bold;">${order.Total}</td>
                    <td>
                        <button class="action-btn btn-print" title="In hóa đơn" onclick="printOrder('${order.OrderId}')"><i class="ri-printer-line"></i></button>
                        <button class="action-btn btn-del" title="Xóa đơn" onclick="deleteOrder('${order.OrderId}')"><i class="ri-delete-bin-line"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 4. TÍNH TOÁN THỐNG KÊ
        function calculateStats(data) {
            document.getElementById('total-orders').innerText = data.length;
            
            let revenue = 0;
            data.forEach(o => {
                // Chuyển chuỗi tiền "135.000đ" thành số 135000
                let price = parseInt(o.Total.replace(/\D/g, '')) || 0;
                revenue += price;
            });
            document.getElementById('total-revenue').innerText = revenue.toLocaleString('vi-VN') + 'đ';
        }

        // 5. IN HÓA ĐƠN
        function printOrder(id) {
            const order = allOrders.find(o => o.OrderId == id);
            if(!order) return;

            document.getElementById('p-id').innerText = order.OrderId;
            document.getElementById('p-name').innerText = order.Name;
            document.getElementById('p-phone').innerText = order.Phone;
            document.getElementById('p-addr').innerText = order.Address;
            document.getElementById('p-total').innerText = order.Total;
            document.getElementById('p-items').innerText = order.Items.replace(/, /g, '\n+ '); // Xuống dòng cho đẹp

            window.print();
        }

        // 6. XÓA ĐƠN HÀNG
        function deleteOrder(id) {
            if(!confirm(`Bạn chắc chắn muốn xóa đơn ${id}? Dữ liệu sẽ mất vĩnh viễn trên Sheet!`)) return;

            // Gọi API xóa
            const formData = new FormData();
            formData.append("action", "delete");
            formData.append("OrderId", id);

            fetch(API_URL, { method: 'POST', body: formData, mode: 'no-cors'})
            .then(() => {
                alert("Đã gửi lệnh xóa! Đợi 2s rồi tải lại.");
                setTimeout(fetchOrders, 2000); // Reload lại bảng
            })
            .catch(err => alert("Lỗi xóa đơn"));
        }
    </script>
</body>
</html>